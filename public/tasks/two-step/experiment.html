<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Two-Step Task</title>

  <!-- Load libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.3/seedrandom.min.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>

  <!-- Initialize jsPsych -->
  <script src="./js/init-jspsych.js"></script>

  <!-- Load jsPsych plug-ins -->
  <script src="./js/plugin-two-step-alien-practice.js"></script>
  <script src="./js/plugin-two-step-trial.js"></script>
  <script src="./js/plugin-two-step-instructions.js"></script>
  <script src="./js/plugin-two-step-comprehension.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>

  <!-- Load experiment -->
  <script src="./js/two-step-experiment.js" type="text/javascript"></script>
  <script src="./js/two-step-instructions.js" type="text/javascript"></script>

  <!-- Load CSS styles -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="./css/two-step-css.min.css" rel="stylesheet" type="text/css"></link>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

  <!-- Firebase Initialization (without module type script) -->
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCA0zQz0WBXJ4DfiDwBBIEXKdKygwJg_Q8",
      authDomain: "utokyo-edup.firebaseapp.com",
      projectId: "utokyo-edup",
      storageBucket: "utokyo-edup.firebasestorage.app",
      messagingSenderId: "92702717304",
      appId: "1:92702717304:web:9e41b501faceff6efb448d",
      measurementId: "G-M9LRC5KRTZ"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);

    // Function to send experiment results to Firestore
    async function sendResults(participant_id, results, dob) {
      try {
        const docRef = await db.collection("results").add({
          participant_id: participant_id,
          results: results,
          dob: dob,
          timestamp: new Date()  // Save the timestamp when the result was submitted
        });
        console.log("Data successfully saved to Firestore, Document ID: ", docRef.id);
      } catch (error) {
        console.error("Error saving data to Firestore:", error);
      }
    }
  </script>

</head>
<body>

  <h1>実験の開始</h1>

  <script>
    // Define image preloading.
    var PRELOAD = {
      type: jsPsychPreload,
      images: preload_images,
      message: 'Loading images. This may take a moment depending on your internet connection.',
      error_message: '<p>The experiment failed to load. Please try restarting your browser.</p><p>If this error persists after 2-3 tries, please contact the experimenter.</p>',
      continue_after_error: false,
      show_progress_bar: true,
      max_load_time: 30000
    };

    // Define fullscreen for experiment
    var FULLSCREEN = {
      type: jsPsychFullscreen,
      fullscreen_mode: true
    };

    window.flowType = Math.random() < 0.5 ? 'flow_1' : 'flow_2';  // Randomly assign flow_1 or flow_2

    // Set seed for randomization
    Math.seedrandom('trial_seed_123');

    // Initialize timeline
    var timeline = [];
    timeline = timeline.concat(PRELOAD);
    timeline = timeline.concat(FULLSCREEN);
    timeline = timeline.concat(INSTRUCTIONS_SKIP);
    timeline = timeline.concat(INSTRUCTIONS);
    timeline = timeline.concat(READY_0);

    // Set timeline based on flow type
    if (flowType === 'flow_1') {
      timeline = timeline.concat(READY_01);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
      timeline = timeline.concat(READY_02);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    } else {
      timeline = timeline.concat(READY_02);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
      timeline = timeline.concat(READY_01);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    }

    timeline = timeline.concat(FINISHED);

    // Get dob (date of birth) from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const dob = urlParams.get('dob'); // Example: "1980-07-15"

    // If dob exists, generate participant_id
    if (dob) {
      let participant_id = dob + '_' + Date.now();  // Example: "1980-07-15_1638474724000"
      localStorage.setItem('participant_id', participant_id);

      console.log('Participant ID:', participant_id);

      // Send results to Firebase after the experiment ends
      const results = {
        // Place actual experiment results here (example: an object or array)
        task: "two-step task",
        score: 85
      };

      // Send results when the timeline finishes
      jsPsych.init({
        display_element: 'jspsych-target',
        timeline: timeline
      }).then(function() {
        // After the experiment ends, send results to Firestore
        sendResults(participant_id, results, dob)
          .then(() => {
            // Redirect to survey page after sending results
            window.location.href = "tasks/hanten/survey.html";  // Redirect to your survey page
          })
          .catch(error => {
            console.error("Error during result submission:", error);
          });
      });
    } else {
      console.error('Date of birth (dob) not provided');
    }

  </script>

</body>
</html>


