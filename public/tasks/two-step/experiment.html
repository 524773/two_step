<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Two-Step Task</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.3/seedrandom.min.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>



  <script src="./js/init-jspsych.js"></script>


  <script src="./js/plugin-two-step-alien-practice.js"></script>
  <script src="./js/plugin-two-step-trial.js"></script>
  <script src="./js/plugin-two-step-instructions.js"></script>
  <script src="./js/plugin-two-step-comprehension.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>


  <script src="./js/two-step-experiment.js" type="text/javascript"></script>
  <script src="./js/two-step-instructions.js" type="text/javascript"></script>

 
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="./css/two-step-css.min.css" rel="stylesheet" type="text/css"></link>
  
  <script type="module" defer>
    import { saveResults } from "./js/saveResults.js";
  </script>

</head>
<body>

</body>
</html>

<script>
  // Define image preloading.
  var PRELOAD = {
    type: jsPsychPreload,
    images: preload_images,
    message: 'Loading images. This may take a moment depending on your internet connection.',
    error_message: '<p>The experiment failed to load. Please try restarting your browser.</p><p>If this error persists after 2-3 tries, please contact the experimenter.</p>',
    continue_after_error: false,
    show_progress_bar: true,
    max_load_time: 30000
  }
  // Define experiment fullscreen.
  var FULLSCREEN = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  }

  window.flowType = Math.random() < 0.5 ? 'flow_1' : 'flow_2';  // ランダムにflow_1またはflow_2を決定

  // Set seed for randomization (you can change 'trial_seed_123' to any desired seed)
  Math.seedrandom('trial_seed_123');

  // Initialize timeline.
  var timeline = [];
  timeline = timeline.concat(PRELOAD);
  timeline = timeline.concat(FULLSCREEN);
  timeline = timeline.concat(INSTRUCTIONS_SKIP);
  timeline = timeline.concat(INSTRUCTIONS);
  timeline = timeline.concat(READY_0);
  

  // フローに基づいてタイムラインを設定
  if (flowType === 'flow_1') {
    timeline = timeline.concat(READY_01);
    timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    timeline = timeline.concat(READY_02);
    timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
  } else {
    timeline = timeline.concat(READY_02);
    timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    timeline = timeline.concat(READY_01);
    timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
  }

  timeline = timeline.concat(FINISHED);
  
  // URLパラメータから生年月日を取得
  const urlParams = new URLSearchParams(window.location.search);
  const dob = urlParams.get('dob'); // 例: "1980-07-15"

  // dobが存在する場合、参加者IDを生成
  if (dob) {
    // 'birthday' + 'runtime'（ミリ秒）を参加者IDとして生成
    let participant_id = dob + '_' + Date.now();  // 例: "1980-07-15_1638474724000"

    // 生成したparticipant_idをlocalStorageに保存
    localStorage.setItem('participant_id', participant_id);

    console.log('参加者ID:', participant_id);  // 確認用のログ

    // 実験結果を保存する処理（仮の結果）
    const results = {
      // 実際の実験結果をここにセット（例: 配列やオブジェクト）
    };

    // saveResults関数を呼び出して、結果と生年月日を送信
    saveResults(participant_id, results, dob)
      .then(data => {
        console.log("結果保存成功:", data);
      })
      .catch(error => {
        console.error("結果保存エラー:", error);
      });
  } else {
    console.error('生年月日が提供されていません');
  }

  // Initialize jsPsych
  jsPsych.init({
    display_element: 'jspsych-target', // 実験を表示する対象のIDを指定
    timeline: timeline                   // 実験のタイムラインを指定
  }).then(function() {
    // 実験が終了した後、アンケートページに遷移
    window.location.href = "tasks/hanten/survey.html"; // lifestyle_questionsフォルダにあるアンケートページ
  });
</script>

</html>
