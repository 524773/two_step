<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Two-Step Task</title>

  <!-- 外部ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.3/seedrandom.min.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>

  <!-- 実験用のJavaScript -->
  <script src="./js/init-jspsych.js"></script>
  <script src="./js/plugin-two-step-alien-practice.js"></script>
  <script src="./js/plugin-two-step-trial.js"></script>
  <script src="./js/plugin-two-step-instructions.js"></script>
  <script src="./js/plugin-two-step-comprehension.js"></script>

  <!-- jsPsychプラグイン -->
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>

  <!-- 実験用の追加JavaScript -->
  <script src="./js/two-step-experiment.js" type="text/javascript"></script>
  <script src="./js/two-step-instructions.js" type="text/javascript"></script>

  <!-- スタイルシート -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="./css/two-step-css.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    // 画像の事前読み込みの設定
    var PRELOAD = {
      type: jsPsychPreload,
      images: preload_images,  // 事前に定義された画像リスト
      message: 'Loading images. This may take a moment depending on your internet connection.',
      error_message: '<p>The experiment failed to load. Please try restarting your browser.</p><p>If this error persists after 2-3 tries, please contact the experimenter.</p>',
      continue_after_error: false,
      show_progress_bar: true,
      max_load_time: 30000
    }

    // フルスクリーンモードの設定
    var FULLSCREEN = {
      type: jsPsychFullscreen,
      fullscreen_mode: true
    }

    // ランダムに実験フローを選択
    window.flowType = Math.random() < 0.5 ? 'flow_1' : 'flow_2';

    // ランダム化のシードを設定
    Math.seedrandom('trial_seed_123');

    // 実験のタイムラインを初期化
    var timeline = [];
    timeline = timeline.concat(PRELOAD);
    timeline = timeline.concat(FULLSCREEN);
    timeline = timeline.concat(INSTRUCTIONS_SKIP);
    timeline = timeline.concat(INSTRUCTIONS);
    timeline = timeline.concat(READY_0);

    // フローに基づいてタイムラインを設定
    if (flowType === 'flow_1') {
      timeline = timeline.concat(READY_01);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
      timeline = timeline.concat(READY_02);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    } else {
      timeline = timeline.concat(READY_02);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
      timeline = timeline.concat(READY_01);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    }

    // 実験終了後の処理
    timeline = timeline.concat(FINISHED);

    // 参加者IDを生成して保存する処理
    const urlParams = new URLSearchParams(window.location.search);
    const dob = urlParams.get('dob'); // 例: "1980-07-15"

    // dobが存在する場合、参加者IDを生成
    if (dob) {
      // 'birthday' + 'runtime'（ミリ秒）を参加者IDとして生成
      let participant_id = dob + '_' + Date.now();  // 例: "1980-07-15_1638474724000"

      // 生成したparticipant_idをlocalStorageに保存
      localStorage.setItem('participant_id', participant_id);

      console.log('参加者ID:', participant_id);  // 確認用のログ

      // 実験結果を保存する処理（仮の結果）
      const results = {
        // 実際の実験結果をここにセット（例: 配列やオブジェクト）
      };

      // 結果をサーバーに送信する処理
      const url = 'https://two-step-git-master-hiroshi-satos-projects.vercel.app/submit-results'; // 実際のURLに変更

      const data = {
        participant_id: participant_id,
        results: results,
        dob: dob
      };

      // fetch APIを使ってPOSTリクエストを送信
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)  // データをJSON形式で送信
      })
        .then(response => response.json())
        .then(data => {
          console.log('結果が正常に送信されました:', data);
        })
        .catch(error => {
          console.error('結果送信エラー:', error);
        });

    } else {
      console.error('生年月日が提供されていません');
    }

    // 実験をjsPsychで初期化
    jsPsych.init({
      display_element: 'jspsych-target', // 実験を表示する対象のID
      timeline: timeline                   // 実験のタイムライン
    }).then(function() {
      // 実験が終了した後、アンケートページに遷移
      window.location.href = "tasks/hanten/survey.html"; // lifestyle_questionsフォルダにあるアンケートページ
    });

  </script>
</body>
</html>



