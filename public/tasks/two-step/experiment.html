<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Two-Step Task</title>

  <!-- 外部ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.3/seedrandom.min.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>

  <!-- 実験用のJavaScript -->
  <script src="./js/init-jspsych.js"></script>
  <script src="./js/plugin-two-step-alien-practice.js"></script>
  <script src="./js/plugin-two-step-trial.js"></script>
  <script src="./js/plugin-two-step-instructions.js"></script>
  <script src="./js/plugin-two-step-comprehension.js"></script>

  <!-- jsPsychプラグイン -->
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>

  <!-- 実験用の追加JavaScript -->
  <script src="./js/two-step-experiment.js" type="text/javascript"></script>
  <script src="./js/two-step-instructions.js" type="text/javascript"></script>

  <!-- スタイルシート -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="./css/two-step-css.min.css" rel="stylesheet" type="text/css" />
  
  <script type="module">
     import { saveResults } from "./js/saveResults.js";    
  </script>
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    // URLパラメータから生年月日を取得
    const urlParams = new URLSearchParams(window.location.search);
    const dob = urlParams.get('dob'); // 例: "1980-07-15"

    // dobが存在する場合、参加者IDを生成してlocalStorageに保存
    if (dob) {
      let participant_id = dob + '_' + Date.now();  // 参加者ID: 生年月日 + 現在のミリ秒
      localStorage.setItem('participant_id', participant_id);
      console.log('参加者ID:', participant_id);

      // 初期結果データ（生年月日、参加者IDなど）
      const initialResults = {
        participant_id: participant_id,
        dob: dob,
        timestamp: new Date().toISOString(),  // 実験開始時のタイムスタンプ
      };

      // 最初のsaveResultsを呼び出して参加者情報を送信
      saveResults(participant_id, initialResults, dob)
        .then(data => {
          console.log("参加者情報保存成功:", data);
        })
        .catch(error => {
          console.error("参加者情報保存エラー:", error);
        });
    } else {
      console.error('生年月日が提供されていません');
    }

    // 画像の事前読み込みの設定
    var PRELOAD = {
      type: jsPsychPreload,
      images: preload_images,  // 事前に定義された画像リスト
      message: 'Loading images. This may take a moment depending on your internet connection.',
      error_message: '<p>The experiment failed to load. Please try restarting your browser.</p><p>If this error persists after 2-3 tries, please contact the experimenter.</p>',
      continue_after_error: false,
      show_progress_bar: true,
      max_load_time: 30000
    }

    // フルスクリーンモードの設定
    var FULLSCREEN = {
      type: jsPsychFullscreen,
      fullscreen_mode: true
    }

    // ランダムに実験フローを選択
    window.flowType = Math.random() < 0.5 ? 'flow_1' : 'flow_2';

    // ランダム化のシードを設定
    Math.seedrandom('trial_seed_123');

    // 実験のタイムラインを初期化
    var timeline = [];
    timeline = timeline.concat(PRELOAD);
    timeline = timeline.concat(FULLSCREEN);
    timeline = timeline.concat(INSTRUCTIONS_SKIP);
    timeline = timeline.concat(INSTRUCTIONS);
    timeline = timeline.concat(READY_0);

    // フローに基づいてタイムラインを設定
    if (flowType === 'flow_1') {
      timeline = timeline.concat(READY_01);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
      timeline = timeline.concat(READY_02);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    } else {
      timeline = timeline.concat(READY_02);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
      timeline = timeline.concat(READY_01);
      timeline = timeline.concat(TWO_STEP_TASK.slice(0, 79));
    }

    // 実験終了後の処理
    timeline = timeline.concat(FINISHED);

    // 実験をjsPsychで初期化
    jsPsych.init({
      display_element: 'jspsych-target', // 実験を表示する対象のID
      timeline: timeline                   // 実験のタイムライン
    }).then(function() {
      // 実験終了後に結果をサーバーに送信
      const finalResults = {
        participant_id: localStorage.getItem('participant_id'),
        dob: dob,
        timestamp: new Date().toISOString(),  // 結果送信時のタイムスタンプ
        // 実際の実験結果をここに追加
        experiment_results: "実験結果のデータ"  // 例: 実験で得られた結果
      };

      // 結果のデータにタイムスタンプと参加者IDをファイル名に含める
      const resultFileName = `${finalResults.participant_id}_${finalResults.timestamp}.json`;

      // saveResultsにファイル名も渡す（必要に応じてファイル名の生成方法を調整）
      saveResults(finalResults.participant_id, finalResults, dob, resultFileName)
        .then(data => {
          console.log("実験結果保存成功:", data);
        })
        .catch(error => {
          console.error("実験結果保存エラー:", error);
        });

      // アンケートページに遷移
      window.location.href = "tasks/hanten/survey.html";
    });
  </script>
</body>
</html>
